<UserControl x:Class="ModernUITestApp.Views.AnnotationView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" 
             d:DesignHeight="300" d:DesignWidth="400">

    <UserControl.Resources>
        <!-- =========================================================
             1. CORE PALETTE & BRUSHES
             ========================================================= -->
        <SolidColorBrush x:Key="MenuBackColor" Color="#FFFFFFFF"/>
        <SolidColorBrush x:Key="MenuBorderColor" Color="#FFE5E5E5"/>
        <SolidColorBrush x:Key="MenuItemHoverColor" Color="#FFF2F4F8"/>
        <SolidColorBrush x:Key="TextPrimaryColor" Color="#1F2937"/>
        <SolidColorBrush x:Key="TextSecondaryColor" Color="#374151"/>
        <SolidColorBrush x:Key="TextMutedColor" Color="#9CA3AF"/>
        <SolidColorBrush x:Key="AccentColor" Color="#3B82F6"/>
        <SolidColorBrush x:Key="DangerColor" Color="#EF4444"/>
        <SolidColorBrush x:Key="InputBackgroundColor" Color="#F3F4F6"/>
        <SolidColorBrush x:Key="KeyCapBackgroundColor" Color="#E5E7EB"/>
        <SolidColorBrush x:Key="KeyCapTextColor" Color="#6B7280"/>

        <!-- =========================================================
             2. CONTEXT MENU STYLES
             ========================================================= -->
        <Style TargetType="{x:Type ContextMenu}">
            <Setter Property="SnapsToDevicePixels" Value="True" />
            <Setter Property="HasDropShadow" Value="True" />
            <Setter Property="Background" Value="{StaticResource MenuBackColor}" />
            <Setter Property="BorderThickness" Value="0.5" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ContextMenu}">
                        <Border Background="White"
                                BorderBrush="#E5E5E5"
                                BorderThickness="1"
                                CornerRadius="8"
                                Padding="4,4">
                            <Border.Effect>
                                <DropShadowEffect BlurRadius="12" Direction="270" Opacity="0.1" ShadowDepth="4"/>
                            </Border.Effect>
                            <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="{x:Type MenuItem}">
            <Setter Property="Header" Value="{Binding Path=Header}"/>
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="#333333"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type MenuItem}">
                        <Border x:Name="Border" 
                                Background="Transparent" 
                                CornerRadius="4" 
                                SnapsToDevicePixels="True">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" SharedSizeGroup="Icon"/>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" SharedSizeGroup="Shortcut"/>
                                </Grid.ColumnDefinitions>
                                
                                <ContentPresenter Grid.Column="0" ContentSource="Icon" Margin="6,0,6,0" VerticalAlignment="Center"/>
                                <ContentPresenter Grid.Column="1" Name="HeaderHost" Margin="6,6,20,6" RecognizesAccessKey="True" ContentSource="Header" VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="2" Text="{TemplateBinding InputGestureText}" Margin="10,0,6,0" Foreground="#999999" FontSize="11" VerticalAlignment="Center"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="{StaticResource MenuItemHoverColor}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- =========================================================
             3. CALLOUT EDITOR STYLES
             ========================================================= -->
        <!-- Container Bubble -->
        <Style x:Key="CalloutContainerStyle" TargetType="Border">
            <Setter Property="Background" Value="#FFFFFF"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="4"/>
            <Setter Property="MinWidth" Value="200"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect BlurRadius="15" Direction="270" ShadowDepth="5" Opacity="0.15" Color="Black"/>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Header Text -->
        <Style x:Key="CalloutHeaderTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="9"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource TextMutedColor}"/>
            <Setter Property="Margin" Value="2,0,0,4"/>
            <Setter Property="Text" Value="EDIT ANNOTATION"/>
        </Style>

        <!-- Input Wrapper (Grey Box) -->
        <Style x:Key="CalloutInputWrapperStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource InputBackgroundColor}"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Padding" Value="8,6"/>
        </Style>

        <!-- TextBox Itself -->
        <Style x:Key="CalloutTextBoxStyle" TargetType="TextBox">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryColor}"/>
            <Setter Property="CaretBrush" Value="{StaticResource AccentColor}"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>

        <!-- =========================================================
             4. HELPER HINT STYLES
             ========================================================= -->
        <!-- Keycap (e.g., [Enter]) -->
        <Style x:Key="HintKeyContainerStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource KeyCapBackgroundColor}"/>
            <Setter Property="CornerRadius" Value="3"/>
            <Setter Property="Padding" Value="4,1"/>
            <Setter Property="Margin" Value="0,0,4,0"/>
        </Style>

        <Style x:Key="HintKeyTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="9"/>
            <Setter Property="Foreground" Value="{StaticResource KeyCapTextColor}"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <!-- Label (e.g., "save") -->
        <Style x:Key="HintLabelTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="9"/>
            <Setter Property="Foreground" Value="{StaticResource TextMutedColor}"/>
            <Setter Property="Margin" Value="0,0,8,0"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

    </UserControl.Resources>

    <Grid>
        <!-- A. The View Mode (Actual Annotation) -->
        <Border Background="Transparent" 
                Cursor="Hand"
                ToolTip="Double-click to Edit">
            
            <TextBlock Text="{Binding Text}" 
                       FontWeight="SemiBold"
                       Foreground="{StaticResource TextSecondaryColor}">
                <TextBlock.InputBindings>
                    <MouseBinding MouseAction="LeftDoubleClick" Command="{Binding StartEditingCommand}" />
                </TextBlock.InputBindings>
            </TextBlock>

            <Border.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="Edit Text" 
                              InputGestureText="DblClick"
                              Command="{Binding PlacementTarget.DataContext.StartEditingCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                    <Separator/>
                    <MenuItem Header="Delete" 
                              Command="{Binding PlacementTarget.DataContext.DeleteCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                              Foreground="{StaticResource DangerColor}"/>
                </ContextMenu>
            </Border.ContextMenu>
        </Border>

        <!-- B. The Editor Mode (Floating Callout) -->
        <Popup IsOpen="{Binding IsEditing, Mode=TwoWay}" 
               StaysOpen="False" 
               Placement="Bottom"
               VerticalOffset="4"
               AllowsTransparency="True"
               PopupAnimation="Fade">
            
            <Border Style="{StaticResource CalloutContainerStyle}">
                <Grid Margin="4">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Header -->
                    <TextBlock Style="{StaticResource CalloutHeaderTextStyle}"/>

                    <!-- Editor Box -->
                    <Border Grid.Row="1" Style="{StaticResource CalloutInputWrapperStyle}">
                        <TextBox Text="{Binding Text, UpdateSourceTrigger=PropertyChanged}" 
                                 Style="{StaticResource CalloutTextBoxStyle}"
                                 AcceptsReturn="True"
                                 PreviewKeyDown="EditorBox_PreviewKeyDown"/>
                    </Border>

                    <!-- Helper Hints -->
                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,6,0,0">
                        
                        <!-- Hint: Shift + Enter -->
                        <Border Style="{StaticResource HintKeyContainerStyle}">
                            <TextBlock Text="Shift+Enter" Style="{StaticResource HintKeyTextStyle}"/>
                        </Border>
                        <TextBlock Text="new line" Style="{StaticResource HintLabelTextStyle}"/>

                        <!-- Hint: Enter -->
                        <Border Style="{StaticResource HintKeyContainerStyle}">
                            <TextBlock Text="Enter" Style="{StaticResource HintKeyTextStyle}"/>
                        </Border>
                        <TextBlock Text="save" Style="{StaticResource HintLabelTextStyle}"/>
                        
                    </StackPanel>
                </Grid>
            </Border>
        </Popup>
    </Grid>
</UserControl>
